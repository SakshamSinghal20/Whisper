version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: whisper-db
    environment:
      POSTGRES_USER: whisper
      POSTGRES_PASSWORD: password
      POSTGRES_DB: whisper
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U whisper"]
      interval: 10s
      timeout: 5s
      retries: 5

  bitcoind:
    image: btcpayserver/bitcoin:26.0
    container_name: whisper-bitcoind
    command: |
      bitcoind
      -regtest
      -server=1
      -rpcuser=bitcoin
      -rpcpassword=password
      -rpcallowip=0.0.0.0/0
      -rpcbind=0.0.0.0
      -txindex=1
      -zmqpubrawblock=tcp://0.0.0.0:28332
      -zmqpubrawtx=tcp://0.0.0.0:28333
    ports:
      - "18443:18443"
      - "28332:28332"
      - "28333:28333"
    volumes:
      - bitcoin_data:/data

  whisper-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: whisper-server
    environment:
      DATABASE_URL: postgres://whisper:password@postgres/whisper
      BITCOIN_RPC_URL: http://bitcoind:18443
      BITCOIN_RPC_USER: bitcoin
      BITCOIN_RPC_PASS: password
      ZMQ_BLOCK_SOCKET: tcp://bitcoind:28332
      NETWORK: regtest
      HOST: 0.0.0.0
      PORT: 3000
      RUST_LOG: info
    ports:
      - "3000:3000"
    depends_on:
      postgres:
        condition: service_healthy
      bitcoind:
        condition: service_started

volumes:
  postgres_data:
  bitcoin_data:
